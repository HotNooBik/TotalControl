{% extends "main/base.html" %}
{% load markdown_extras %}
{% block content %}

<div class="container py-5">
    <div class="row justify-content-center mb-3 text-center">
        <div class="col-12">
            <div class="card shadow" style="border-radius: 15px;">

                <h2 class="card-header py-4 fw-bold bg-ferngreen text-white justify-content-center shadow-sm border-bottom-0" 
                    style="border-top-left-radius: 15px; border-top-right-radius: 15px;">
                    <i class="fa-solid fa-robot"></i> 
                    Чат с ИИ-помощником по питанию
                </h2>

                <div class="card-body bg-ferngreen border-bottom-0 mb-0">
                    <div class="row p-1 bg-light-subtle m-0 pt-3">
                        <div class="col-lg-12" style="max-height: 50vh; overflow-y: auto; margin-bottom: 20px;" id="chat">
                        {% for message in messages %}
                            {% if message.role == 'user' %}
                                <div class="row d-flex flex-row justify-content-end pt-1 mt-2">
                                    <div class="col-auto">
                                        {% if message.content %}
                                            <div class="px-3 py-2 ms-3 mb-2 my-2 rounded-3 bg-ferngreen-lighter text-start">
                                                {{ message.content }}
                                            </div>
                                        {% endif %}
                                        {% if message.image_data %}
                                        <div class="d-flex justify-content-end my-2">
                                            <img src="{{ message.image_data }}" class="img-fluid" style="border-radius: 15px; max-width: 100%; height: auto;" alt="Image">
                                        </div>
                                        {% endif %}
                                        <p class="small ms-3 mt-2 rounded-3 text-muted d-flex justify-content-end">{{ message.date_sent|date:"d.m.Y H:i" }}</p>
                                    </div>
                                </div>
                            {% else %}
                                <div class="row d-flex flex-row justify-content-lg-start pt-1 mt-2">
                                    <div class="col-auto">
                                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-ferngreen text-white" 
                                             style="width: 50px; height: 50px;">
                                            <i class="fa-solid fa-robot fs-3"></i>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        {% if message.content %}
                                            <div class="px-3 py-2 pb-1 ms-3 my-2 rounded-3 bg-secondary-subtle text-start">
                                                {{ message.content|markdownify|safe }}
                                            </div>
                                        {% endif %}
                                        {% if message.image_data %}
                                        <div class="d-flex justify-content-lg-start my-2">
                                            <img src="{{ message.image_data }}" class="img-fluid" style="border-radius: 15px; max-width: 100%; height: auto;" alt="Image">
                                        </div>
                                        {% endif %}
                                        <p class="small ms-3 mt-2 rounded-3 text-muted d-flex justify-content-lg-start">{{ message.date_sent|date:"d.m.Y H:i" }}</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% empty %}
                            <p>Пока нет сообщений.</p>
                        {% endfor %}
                        </div>

                        <div id="preview" class="d-flex justify-content-lg-start"></div>
                        <form method="post" enctype="multipart/form-data" class="mb-2" id="sendMsg">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-12 d-flex justify-content-start align-items-center">
                                    <label class="btn btn-sm me-2">
                                        <i class="fa-solid fa-paperclip fs-5"></i>
                                        <input type="file" name="image" accept="image/*" hidden id="file-input">
                                    </label>
                                    <textarea name="message" class="form-control" rows="1" placeholder="Введите ваш вопрос..." id="message-box"></textarea>
                                    <button type="submit" class="btn btn-outline-success btn-md ms-2">
                                        <i class="fas fa-paper-plane fs-5"></i>
                                    </button>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>

                <div class="card-footer bg-ferngreen text-white d-flex justify-content-between align-items-center border-top-0 mb-0"
                     style="border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;">
                    <span class="text-black-50 fw-semibold fs-6">
                        Используется модель qwen2.5-vl-72b
                    </span>
                    <form method="post">
                        {% csrf_token %}
                        <button type="submit" name="clear" class="btn fc-brunswickgreen" title="Очистить чат">
                            <i class="fa-solid fa-trash-can fs-3"></i>
                        </button>
                    </form>
                </div>
            
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const link = document.getElementById("chat-link");
        link.classList.remove('fs-5');
        link.classList.add('menu-link-active', 'fs-4');

        const fileInput = document.getElementById('file-input');
        const preview = document.getElementById('preview');
        const messageBox = document.getElementById('message-box');
        const form = document.getElementById('sendMsg');
        const messageArea = document.getElementById('chat');

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function renderPreviewImage(imageSrc) {
            preview.innerHTML = `
                <div class="position-relative d-inline-block">
                    <img src="${imageSrc}" class="img-fluid rounded border" style="height:50px; width:50px;" alt="Предпросмотр изображения">
                    <button type="button" class="btn-close position-absolute top-0 start-100 translate-middle" 
                            aria-label="Удалить изображение" style="background-color: white;" id="remove-image"></button>
                </div>
            `;
            document.getElementById('remove-image').addEventListener('click', () => {
                fileInput.value = '';
                preview.innerHTML = '';
            });
        }

        document.addEventListener('paste', function (event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.type.indexOf("image") !== -1) {
                    const blob = item.getAsFile();
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(blob);
                    fileInput.files = dataTransfer.files;

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        renderPreviewImage(e.target.result);
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        fileInput.addEventListener("change", () => {
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    renderPreviewImage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const messageText = escapeHTML(messageBox.value.trim());
            if (!messageText) return;
            
            const file = fileInput.files[0];

            function finishAndSubmit() {
                const botMessage = document.createElement('div');
                botMessage.className = 'row d-flex flex-row justify-content-lg-start mb-3 pt-1';
                botMessage.innerHTML = `
                    <div class="col-auto">
                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-ferngreen text-white" 
                            style="width: 50px; height: 50px;">
                            <i class="fa-solid fa-robot fs-3"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="px-3 py-2 pb-1 ms-3 my-2 rounded-3 bg-secondary-subtle text-start">
                            <span class="typing-dots">
                                <span class="dot">.</span>
                                <span class="dot">.</span>
                                <span class="dot">.</span>
                            </span>
                        </div>
                    </div>
                `;
                messageArea.appendChild(botMessage);
                messageArea.scrollTop = messageArea.scrollHeight;

                setTimeout(() => {
                    form.submit();
                    messageBox.value = '';
                    fileInput.value = '';
                    preview.innerHTML = '';
                }, 500);
            }

            let userMessageHTML = `
                <div class="row d-flex flex-row justify-content-end mb-3 pt-1">
                    <div class="col-auto">
                        ${messageText ? `<div class="px-3 py-2 ms-3 my-2 rounded-3 bg-ferngreen-lighter text-start">${messageText}</div>` : ''}
            `;

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    userMessageHTML += `
                            <div class="d-flex justify-content-end my-2">
                                <img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px; max-width: 200px;" alt="Image">
                            </div>
                            <p class="small ms-3 mt-2 rounded-3 text-muted d-flex justify-content-end">сейчас</p>
                        </div>
                    </div>
                    `;
                    messageArea.insertAdjacentHTML('beforeend', userMessageHTML);
                    messageArea.scrollTop = messageArea.scrollHeight;
                    finishAndSubmit();
                };
                reader.readAsDataURL(file);
            } else {
                userMessageHTML += `<p class="small ms-3 mt-2 rounded-3 text-muted d-flex justify-content-end">сейчас</p></div></div>`;
                messageArea.insertAdjacentHTML('beforeend', userMessageHTML);
                messageArea.scrollTop = messageArea.scrollHeight;
                finishAndSubmit();
            }
        });

        messageArea.scrollTop = messageArea.scrollHeight;
    });
</script>

<style>
    .typing-dots {
        display: inline-block;
        font-size: 1.5rem;
    }
    .typing-dots .dot {
        animation: blink 1s infinite;
        animation-delay: calc(var(--i) * 0.2s);
    }
    .typing-dots .dot:nth-child(1) { --i: 0; }
    .typing-dots .dot:nth-child(2) { --i: 1; }
    .typing-dots .dot:nth-child(3) { --i: 2; }

    @keyframes blink {
        0%, 80%, 100% { opacity: 0; }
        40% { opacity: 1; }
    }
</style>

{% endblock content %}